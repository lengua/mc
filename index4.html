<!DOCTYPE html>
<html lang="es" xml:lang="es">
<head>
  <meta charset="utf-8">
  <!-- <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> -->
  <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <meta name="description" content="Metrónomo circular polirrítmico">
  <meta name="author" content="Santiago Chávez">
  <title>Metrónomo circular polirrítmico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Allow web app to be run in full-screen mode. -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Metrónomo circular polirrítmico">
  <meta name="apple-mobile-web-app-title" content="Metrónomo circular polirrítmico">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <!-- Disable automatic phone number detection. -->
  <meta name="format-detection" content="telephone=no">
  <!-- FAVICON -->
  <link rel="shortcut icon" href="favicon.png" type="image/png">
  <link rel="icon" href="favicon.png" type="image/png">
  <!-- STYLES -->
  <link rel="stylesheet" type="text/css" href="w3.css">
  <link rel="stylesheet" type="text/css" href="metronomo.css">

</head>
<body>

  <!-- CONTENTS -->
  <div class="exterior bloque" style="vertical-align: top;">
    <div class="bloque rs" id="canvasResizer">
        <canvas id="canvas" width="800" height="800"></canvas>
    </div>
    <div class="bloque ts">

      <table  style="width: 98%;margin-top: 12px;">
        <tr>
          <td style="text-align:center;"></td>
          <td style="text-align:center;" class="w3-text-gray">Volumen:</td>
        </tr>
        <tr>
          <td style="text-align:center;"><button style="width: 92%;" id="playButton" class="w3-xlarge w3-button w3-green w3-round">Play</button></td>
          <td style="text-align:center;" class="w3-text-gray"><input style="width: 92%;" type="range" id="vol" min="0" max="1.0" step="0.05"></td>
        </tr>
      </table>
      
      <table class="interior cuadricula">
        <tr class="w3-large fondo1">
          <td class="text w3-medium">Activo:</td>
          <td><label class="container"><input class="activo" type="checkbox" checked="checked"><span class="checkmark"></span></label></td>
          <td><label class="container"><input class="activo" type="checkbox" checked="checked"><span class="checkmark"></span></label></td>
          <td><label class="container"><input class="activo" type="checkbox" checked="checked"><span class="checkmark"></span></label></td>
          <td><label class="container"><input class="activo" type="checkbox" checked="checked"><span class="checkmark"></span></label></td>
          <td class="fin"><label class="container"><input class="activo" type="checkbox" checked="checked"><span class="checkmark"></span></label></td>
        </tr>
        <tr class="w3-large">
          <td class="text w3-medium">Número:</td>
          <td><input class="nmax" type="number" value="" min="0" max="64"></td>
          <td><input class="nmax" type="number" value="" min="0" max="64"></td>
          <td><input class="nmax" type="number" value="" min="0" max="64"></td>
          <td><input class="nmax" type="number" value="" min="0" max="64"></td>
          <td class="fin"><input class="nmax" type="number" value="" min="0" max="64"></td>
        </tr>
        <tr class="w3-large fondo1">
          <td class="text w3-medium">Pulso:</td>
          <td><input class="pulso" type="text" readonly="readonly" value="0"></td>
          <td><input class="pulso" type="text" readonly="readonly" value="0"></td>
          <td><input class="pulso" type="text" readonly="readonly" value="0"></td>
          <td><input class="pulso" type="text" readonly="readonly" value="0"></td>
          <td class="fin"><input class="pulso" type="text" readonly="readonly" value="0"></td>
        </tr>
        <tr class="w3-large">
          <td class="text w3-medium">BPM:</td>
          <td><input class="bpm" type="text" value="" readonly="readonly"></td>
          <td><input class="bpm" type="text" value="" readonly="readonly"></td>
          <td><input class="bpm" type="text" value="" readonly="readonly"></td>
          <td><input class="bpm" type="text" value="" readonly="readonly"></td>
          <td class="fin"><input class="bpm" type="text" value="" readonly="readonly"></td>
        </tr>
        <tr class="w3-large">
          <td class="text w3-medium">CPM:</td>
          <td><input lang="en-US" type="number" s step="0.1" id="cpm" value=""></td>
          <td class="text w3-medium">Tipo:</td>
          <td><input id="tipbip" type="number" min=0 max=3 step=1 value=""></td>
        </tr>
        <tr class="w3-large">
          <td class="text w3-medium">Compás:</td>
          <td><input type="number" id="compas" step=1></td>
          <td class="text w3-medium">Pulso:</td>
          <td><input type="number" id="pulso" step=1></td>
        </tr>
      </table>

    </div>
  </div>
  <!-- DEBUG -->
  <textarea id="consola" style="box-sizing:border-box;width:100%;height: 300px;"></textarea>
  <!-- SCRIPTS -->
  <script type="text/javascript" src="metronomo.js"></script>
  <script>
    // 0. DEFINICIÓN DE VARIABLES --------------------------
    // debug
    document.getElementById('consola').value='';
    var timp = null;
    var timprom = [];

    // Objetos y Variables globales
    const canvas = document.getElementById("canvas");
    // Detecta los click dentro del canvas
    canvas.onclick = clickDetector;
    const ctx = canvas.getContext("2d");
    // Objeto de audio
    const contextClass = window.audioContext || window.AudioContext || window.AudioContext || window.webkitAudioContext
    const context = new contextClass();

    // Variable que guarda cada variable poliritmia
    var pol = [
      {
        'activo':true,
        'nmax':11,
        'pulso':0,
        'patron':[48,36,36,36,36,36,36,36,36,36,36],
        'vol':[1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0],
      },
      {
        'activo':false,
        'nmax':7,
        'pulso':0,
        'patron':[52,39,39,39,39,39,39],
        'vol':[1.0,1.0,1.0,1.0,1.0,1.0,1.0],
      },
      {
        'activo':false,
        'nmax':5,
        'pulso':0,
        'patron':[42,33,33,33,33],
        'vol':[1.0,1.0,1.0,1.0,1.0],
      },
      {
        'activo':false,
        'nmax':3,
        'pulso':0,
        'patron':[38,26,26],
        'vol':[1.0,1.0,1.0],
      },
      {
        'activo':false,
        'nmax':2,
        'pulso':0,
        'patron':[32,28],
        'vol':[1.0,1.0],
      }
    ];
    var colores = [
      ['#099','#9ff'],
      ['#e80','#ff9'],
      ['#e0e','#f9f'],
      ['#4e4','#9f9'],
      ['#44e','#99f'],
    ];
    var regiones = [];
    var isPlaying = false;
    const fradius = canvas.height / 2; // Full box radius
    const bordep = 0.05; // Porcentaje de borde (0 - 1)
    const radius = fradius * (1-bordep); // Un poco más pequeño que el canvas
    ctx.translate(fradius, fradius); // Movemos el centro
    var compas = 0;
    var angulo = 0;
    var vol = 0.5;
    var tipbip = 3; // Tipo de onda en el oscilador: 0='sine', 1='square', 2='sawtooth', 3='triangle'
    var pulso = 0;
    var cpm = 30;
    var cps = cpm/60;
    var maxBeepDuration = 0.25; // Duracion del beep
    var pola = soloActivos(JSON.parse(JSON.stringify(pol)));
    var operado = multiplicar(pola);
  </script>
  <script>
    // 1. INTERFAZ y LISTENERS ----------------------------------
    // Definiciones interfaz ----------
    const listaNmax = document.getElementsByClassName('nmax');
    const listaActivo = document.getElementsByClassName('activo');
    const claNames = ['nmax'];
    // Consola debug
    const consola = (t,clean=false) => {
      if(clean)document.getElementById('consola').value="";
      document.getElementById('consola').value=t+"\n"+document.getElementById('consola').value;
    };
    // Listeners ----------------------
    document.getElementById('canvasResizer').onclick = function(){
      this.style.width=this.style.height;
    };
    document.getElementById('cpm').onchange = function() {
      cpm=this.value;
      cps=cpm/60;
      updateBPM();
    };
    document.getElementById('tipbip').onchange = function() {
      tipbip=this.value;
    }
    document.getElementById('compas').onchange = function() {
      compas=this.value;
    };
    document.getElementById('vol').onchange = function() {
      vol=this.value;
    };
    document.getElementById('pulso').onchange = function() {
      pulso=this.value;
    };
    document.getElementById('playButton').onclick = function() {
      if(isPlaying)stop();
      else play();
    };
    // Listeners Complejos
    for (var i = 0; i < listaNmax.length; ++i) {
      (function(index){
        listaNmax[index].onchange = function() {
          pol[index]['nmax']=this.value;
          var mem = pol[index]['patron'];
          pol[index]['patron']=[];
          for (var i = 0; i < pol[index]['nmax']; i++) {
            if(mem[i]>=0)pol[index]['patron'].push(mem[i]);
            else pol[index]['patron'].push(1);
          }
          document.getElementsByClassName('bpm')[index].value=Math.round(this.value*cpm);
          drawClock(); // metronomo.js
        }
      }(i));
    }
    for (var i = 0; i < listaActivo.length; ++i) {
      (function(index){
        listaActivo[index].onchange = function() {
          pol[index]['activo']=this.checked;
          drawClock(); // metronomo.js
          /*if(isPlaying) {
            stop();
            setTimeout('play();',500); // metronomo.js
          }*/
        }
      }(i));
    }
  </script>
  <script>
    // 2. CARGA DE DATOS A INTERFAZ  ------------------------------
    for (var j = 0; j < claNames.length; j++) {
      const lista = document.getElementsByClassName(claNames[j]);
      for (var i = 0; i < lista.length; ++i) {
        lista[i].value=pol[i][claNames[j]];
      }
    }
    for (var i = 0; i < listaActivo.length; ++i) {
      listaActivo[i].checked=pol[i]['activo'];
    }
    // Simples
    document.getElementById("pulso").value=pulso;
    document.getElementById("vol").value=vol;
    document.getElementById("tipbip").value=tipbip;
    // 60000/(ti*segs) // Tiempo por vuelta en ms / minuto
    document.getElementById("cpm").value=cpm;
    document.getElementById("compas").value=compas;
  </script>
  <script>
    // 3. EJECUCIÓN ----------------------------------------------
    updateBPM();
    drawFace(ctx,radius,bordep); // metronomo.js
    drawClock(); // metronomo.js
  </script>
</body>
</html>


