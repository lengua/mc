<!DOCTYPE html>
<html lang="en" xml:lang="en">
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<!-- <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0"/> -->
<!-- Search Engine -->
<meta name="description" content="Metrónomo irregular polirrítmico">
<meta name="image" content="/mc/img/metronomo_705x368.png">
<meta name="author" content="Santiago Chávez Novaro">
<link rel="manifest" href="/mc/manifest.json">
<title>Metrónomo irregular polirrítmico</title>
<meta name="theme-color" content="#202020" />
<!-- Allow web app to be run in full-screen mode. -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="mobile-web-app-capable" content="yes">
<meta name="application-name" content="Metrónomo polirrítmico">
<meta name="apple-mobile-web-app-title" content="Metrónomo polirrítmico">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="/mc/img/launcher-icon-4x.png">
<!-- Open Graph general (Facebook, Pinterest & Google+) -->
<meta name="og:title" content="Metrónomo irregular polirrítmico">
<meta name="og:description" content="Metrónomo irregular polirrítmico en línea, gratuito y libre. Sin anuncios.">
<meta name="og:image" content="/mc/img/metronomo.png">
<meta name="og:url" content="https://lengua.la/mc/">
<meta name="og:site_name" content="La Lengua">
<meta name="og:locale" content="es_MX">
<meta name="og:type" content="website">
<meta name="website:author" content="Santiago Chávez Novaro">
<!-- Schema.org for Google -->
<meta itemprop="name" content="Metrónomo polirrítmico">
<meta itemprop="description" content="Metrónomo irregular polirrítmico en línea, gratuito y libre. Sin anuncios.">
<meta itemprop="image" content="/mc/img/metronomo.png">
<!-- Twitter -->
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Metrónomo polirrítmico">
<meta name="twitter:description" content="Metrónomo irregular polirrítmico en línea, gratuito y libre. Sin anuncios.">
<meta name="twitter:site" content="@grupolalengua">
<meta name="twitter:creator" content="@sanxofon">
<meta name="twitter:image:src" content="https://lengua.la/mc/img/metronomo.png">

<!-- Disable automatic phone number detection. -->
<meta name="format-detection" content="telephone=no">
<!-- FAVICON -->
<link rel="shortcut icon" href="/mc/favicon.png" type="image/png">
<link rel="icon" href="/mc/favicon.png" type="image/png">
<!-- STYLES -->
<link rel="stylesheet" type="text/css" href="/mc/w3.css">
<link rel="stylesheet" type="text/css" href="/mc/mc.css">
</head>
<body>

<div class="exterior bloque" style="vertical-align: top;">
  <div class="bloque rs" id="canvasResizer">
      <canvas id="canvas" width="800" height="800"></canvas>
  </div>
  <div class="bloque ts">
    <table style="width: 98%;margin-top: 12px;">
      <tr>
        <td colspan="2" style="text-align:center;">
          <button style="width: 92%;" id="playButton" class="w3-xlarge w3-button w3-green w3-round">Play</button>
        </td>
      </tr>
      <tr>
        <td style="text-align:center;" class="w3-text-grey">
          <br><br><input style="width: 92%;" type="range" id="vol" min="0" max="1" step="0.05"><br>Volumen general<br>
        </td>
        <td><button onclick="document.getElementById('canal-modal').style.display='block';" style="width: 100%;padding:3px;" class="w3-button w3-round-xlarge w3-grey"><img src="/mc/img/cog.png" width="100%"></i></button></td>
      </tr>
      <tr>
        <td style="text-align:center;" class="w3-text-grey">
          <br><input style="width: 92%;" class="small" type="range" id="cpmslide" step="0.1" min="10" max="60"><br>Compases Por Minuto<br>
        </td>
        <td width="80"><input class="w3-xlarge" type="number" id="cpm" step="0.1" min="1" max="90" style="border: none;background-color: #333;padding: 0;line-height: 100%;"></td>
      </tr>
    </table>

    <div style="width: 98%; margin: 0 auto;"><input type="text" id="clave" value="" class="small" style="background-color:#404040;"></div>
    
    <table class="cuadricula" style="width: 98%; margin: 0 auto;">
      <tr class="w3-large fondo1">
        <td><label class="container"><input class="activo" type="checkbox" checked="checked"><span class="checkmark"></span></label></td>
        <td><label class="container"><input class="activo" type="checkbox" checked="checked"><span class="checkmark"></span></label></td>
        <td><label class="container"><input class="activo" type="checkbox" checked="checked"><span class="checkmark"></span></label></td>
        <td><label class="container"><input class="activo" type="checkbox" checked="checked"><span class="checkmark"></span></label></td>
        <td><label class="container"><input class="activo" type="checkbox" checked="checked"><span class="checkmark"></span></label></td>
        <td class="text w3-medium">Activo</td>
      </tr>
      <tr class="w3-large">
        <td><input class="nmax" type="number" min="0" max="64"></td>
        <td><input class="nmax" type="number" min="0" max="64"></td>
        <td><input class="nmax" type="number" min="0" max="64"></td>
        <td><input class="nmax" type="number" min="0" max="64"></td>
        <td><input class="nmax" type="number" min="0" max="64"></td>
        <td class="text w3-medium">Número</td>
      </tr>
      <tr class="w3-large fondo1">
        <td><input class="bpm" type="text" readonly="readonly"></td>
        <td><input class="bpm" type="text" readonly="readonly"></td>
        <td><input class="bpm" type="text" readonly="readonly"></td>
        <td><input class="bpm" type="text" readonly="readonly"></td>
        <td><input class="bpm" type="text" readonly="readonly"></td>
        <td class="text w3-medium">BPM</td>
      </tr>
      <tr class="w3-large">
        <td><input class="pulso" type="text" readonly="readonly"></td>
        <td><input class="pulso" type="text" readonly="readonly"></td>
        <td><input class="pulso" type="text" readonly="readonly"></td>
        <td><input class="pulso" type="text" readonly="readonly"></td>
        <td><input class="pulso" type="text" readonly="readonly"></td>
        <td class="text w3-medium">Pulso</td>
      </tr>
      <tr class="w3-large fondo1">
        <td><input orient="vertical" class="vol vertical" type="range" min="0.0" max="1.0" step="0.01"></td>
        <td><input orient="vertical" class="vol vertical" type="range" min="0.0" max="1.0" step="0.01"></td>
        <td><input orient="vertical" class="vol vertical" type="range" min="0.0" max="1.0" step="0.01"></td>
        <td><input orient="vertical" class="vol vertical" type="range" min="0.0" max="1.0" step="0.01"></td>
        <td><input orient="vertical" class="vol vertical" type="range" min="0.0" max="1.0" step="0.01"></td>
        <td class="text w3-medium">Vol</td>
      </tr>
      <tr class="w3-large">
        <td><input class="octava" type="number" min="0" max="10" step="1"></td>
        <td><input class="octava" type="number" min="0" max="10" step="1"></td>
        <td><input class="octava" type="number" min="0" max="10" step="1"></td>
        <td><input class="octava" type="number" min="0" max="10" step="1"></td>
        <td><input class="octava" type="number" min="0" max="10" step="1"></td>
        <td class="text w3-medium">Octava</td>
      </tr>
      <tr class="w3-large fondo1">
        <td><input class="tipbip" type="number" min=0 max=3 step=1></td>
        <td><input class="tipbip" type="number" min=0 max=3 step=1></td>
        <td><input class="tipbip" type="number" min=0 max=3 step=1></td>
        <td><input class="tipbip" type="number" min=0 max=3 step=1></td>
        <td><input class="tipbip" type="number" min=0 max=3 step=1></td>
        <td class="text w3-medium">Tipo</td>
      </tr>
    </table>

    <div align="center" class="w3-text-white w3-small"><a href="javascript:void(0);" class="w3-text-grey" onclick="toggleClass('vermas','oculto');">Opciones avanzadas</a></div>
    <div class="oculto" id="vermas">
      <table width="96%" style="margin: 0 auto;">
        <!-- <tr class="fondo1 w3-large">
          <td class="text w3-medium">Ángulo:</td><td><input type="text" id="angulo" readonly="readonly"></td>
        </tr> -->
        <tr class="w3-large">
          <td class="text w3-small" title="Compás #">Co:<input type="number" id="compas" step=1 style="width: 70%;"></td>
          <td class="text w3-small" title="CPM Real">CR: <input type="text" id="cpmr" readonly="readonly" style="width: 70%;"></td>
        </tr>
        <tr class="w3-large">
          <td class="text w3-small" title="Micropulso imperceptible">Ss:&nbsp;<input type="text" id="segs" min="1" max="240" step="1.000" readonly="readonly" style="width: 70%;"></td>
          <td class="text w3-small" title="Intervalo de tiempo mímimo">Ti:&nbsp;<input type="text" id="ti" step="1.000" readonly="readonly" style="width: 70%;"></td>
          <td class="text w3-small" title="Error de precisión máximo en microsegundos">Pr:&nbsp;<input type="text" id="precisionmax" readonly="readonly" ondblclick="precisionmax=0;" style="width: 70%;"><!-- <input type="text" id="precision" readonly="readonly" style="width: 50%;"> --></td>
        </tr>
        <tr class="w3-large">
          <td colspan="3" style="text-align:center; padding:20px;" class="w3-text-grey w3-small"><button class="w3-button w3-green w3-round w3-small" id="playSync">PlaySync</button>&nbsp;<input type="number" id="ss" value="2" style="width: 30%;" class="w3-small"> segundos</td>
        </tr>
      </table>
    </div>
  </div>
  <div align="center" class="w3-text-grey w3-small" style="background: #101010;">
    <div><b>Metrónomo irregular polirrítmico</b> v1.8</div>
    <div>Creado por <a href="https://lengua.la" target="_blank" title="(2018-2019)">Santiago C. Novaro</a></div>
  </div>
</div>

<div id="canal-modal" class="w3-modal">
  <div class="w3-modal-content w3-card-4 w3-dark-grey w3-animate-zoom" style="background-color: #202020 !important; max-width: 500px;">
    <header class="w3-container w3-dark-grey w3-padding">
      <button class="w3-button w3-right w3-white w3-border" 
      onclick="document.getElementById('canal-modal').style.display='none'">Cerrar</button>
      <h2 style="margin:0;padding:0;">Configurar<span id="canal-num"></span></h2>
    </header>
    <div class="w3-container">
      <p class="w3-padding">Define las <b>notas</b> y el <b>volumen</b> del golpe, el acento y el silencio.</p>
      <div class="w3-padding" style="border: 1px solid #606060;">
        <table align="center" class="w3-large" style="width:100%;max-width: 400px; margin:0 auto;">
          <tr>
            <td align="right">Golpe:</td><td><select id="notu1"><option value="0" selected>A</option><option value="1">A#</option><option value="2">B</option><option value="3">C</option><option value="4">C#</option><option value="5">D</option><option value="6">D#</option><option value="7">E</option><option value="8">F</option><option value="9">F#</option><option value="10">G</option><option value="11">G#</option><option value="12">AUTO</option></select></td><td><input class="small" type="range" id="volu1" min="0" max="1" step="0.05" value="0.5"></td>
          </tr>
          <tr>
            <td align="right">Acento:</td><td><select id="notu2"><option value="0">A</option><option value="1">A#</option><option value="2">B</option><option value="3">C</option><option value="4">C#</option><option value="5">D</option><option value="6">D#</option><option value="7" selected>E</option><option value="8">F</option><option value="9">F#</option><option value="10">G</option><option value="11">G#</option><option value="12">AUTO</option></select></td><td><input class="small" type="range" id="volu2" min="0" max="1" step="0.05" value="1.0"></td>
          </tr>
        </table>
      </div>
      <p class="w3-padding w3-text-grey">Si seleccionas <b>AUTO</b> la frecuencia en <b>Hertz</b> de cada golpe está dada por su posición en el círculo. La <b>afinación</b> de la escala cromática se puede generar con un <b>número</b> de <b>12</b>.</p>
      <p>&nbsp;</p>
    </div>

  </div>
</div>
<script type="text/javascript">
  // Este código verifica si la API del service worker está disponible. Si está disponible, se registra el service worker de /mc/sw.js una vez que se carga la página.
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('/mc/sw.js').then(function(registration) {
        // Registration was successful
        console.log('ServiceWorker registrado exitosamente en: ', registration.scope);
      }, function(err) {
        // registration failed :(
        console.log('Error en el registro del ServiceWorker: ', err);
      });
    });
  }
  // Toggle css class
  function toggleClass(id,cla) {
    var element = document.getElementById(id);
    if (element.classList) { 
      element.classList.toggle(cla);
    } else {
      var classes = element.className.split(" ");
      var i = classes.indexOf(cla);
      if (i >= 0) 
        classes.splice(i, 1);
      else 
        classes.push(cla);
        element.className = classes.join(" "); 
    }
  }
  // Variable que guarda cada variable poliritmia
  var pol = [
    {
      'activo':false,
      'nmax':11,
      'octava':5,
      'tipbip':3,
      'pulso':0,
      'vol':0.5,
      'patron':[2,1,1,1,1,1,1,1,1,1,1],
    },
    {
      'activo':false,
      'nmax':7,
      'octava':4,
      'tipbip':3,
      'pulso':0,
      'vol':0.5,
      'patron':[2,1,1,1,1,1,1],
    },
    {
      'activo':true,
      'nmax':5,
      'octava':4,
      'tipbip':3,
      'pulso':0,
      'vol':0.5,
      'patron':[2,1,1,1,1],
    },
    {
      'activo':true,
      'nmax':3,
      'octava':3,
      'tipbip':3,
      'pulso':0,
      'vol':0.5,
      'patron':[2,1,1],
    },
    {
      'activo':false,
      'nmax':2,
      'octava':2,
      'tipbip':3,
      'pulso':0,
      'vol':0.5,
      'patron':[2,0],
    }
  ];
  var clave = '11.b/9.9/7.7/5.5/3.3';
</script>
<script type="text/javascript">
class mrythm { static base62encode(integer) { const chars = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"; var arrayOfChars = chars.split(""); if (integer === 0) {return '0';} var s = ''; while (integer > 0) { s = arrayOfChars[integer % 62] + s; integer = Math.floor(integer/62); } return s; } static base62decode(base62String) { const chars = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"; var arrayOfChars = chars.split(""); var val = 0, base62Chars = base62String.split("").reverse(); base62Chars.forEach(function(character, index){ val += arrayOfChars.indexOf(character) * Math.pow(62, index); }); return val; } static base62expand(clave) { clave = String(clave).split('.'); var silencio=''; if(clave[0].charAt(0)==='-'){ silencio='-'; clave[0]=clave[0].replace(/^\-+/,""); } clave[1] = clave[1].split(''); for (var i = 0; i < clave[1].length; i++) { clave[1][i]=this.base62decode(clave[1][i]); } clave[1] = clave[1].join('_'); return silencio+clave.join('.'); } static base62contract(clave) { clave = String(clave).split('.'); var silencio=''; if(clave[0].charAt(0)==='-'){ silencio='-'; clave[0]=clave[0].replace(/^\-+/,""); } clave[1] = clave[1].split('_'); for (var i = 0; i < clave[1].length; i++) { clave[1][i]=this.base62encode(clave[1][i]); } clave[1] = clave[1].join(''); return silencio+clave.join('.'); } static clean(a) { for(var i = 0; i < a.length; i++) { if(a[i] === "") { a.splice(i, 1); } } return a; } static infixToPostfix(infix) { var outputQueue = ""; var operatorStack = []; var operators = { "*": { precedence: 4, associativity: "Left" }, "/": { precedence: 3, associativity: "Left" }, "+": { precedence: 2, associativity: "Left" }, }; infix = infix.replace(/\s+/g, ""); infix = this.clean(infix.split(/([\+\*\/\(\)])/)); for(var i = 0; i < infix.length; i++) { var token = infix[i]; if("*/+".indexOf(token) !== -1) { var o1 = token; var o2 = operatorStack[operatorStack.length - 1]; while("*/+".indexOf(o2) !== -1 && ((operators[o1].associativity === "Left" && operators[o1].precedence <= operators[o2].precedence) || (operators[o1].associativity === "Right" && operators[o1].precedence < operators[o2].precedence))) { outputQueue += operatorStack.pop() + " "; o2 = operatorStack[operatorStack.length - 1]; } operatorStack.push(o1); } else if(token === "(") { operatorStack.push(token); } else if(token === ")") { while(operatorStack[operatorStack.length - 1] !== "(") { outputQueue += operatorStack.pop() + " "; } operatorStack.pop(); } else { outputQueue += token + " "; } } while(operatorStack.length > 0) { outputQueue += operatorStack.pop() + " "; } return outputQueue; } static solvePostfix(postfix) { var resultStack = []; postfix = postfix.trim().split(" "); for(var i = 0; i < postfix.length; i++) { if(postfix[i] === "") { continue; } else if("/*+".indexOf(postfix[i]) !== -1) { const a = resultStack.pop(); const b = resultStack.pop(); const c = this.operar(a,b,postfix[i]); resultStack.push(c); } else { resultStack.push(postfix[i]); } } if(resultStack.length > 1) { return "error"; } else { return resultStack.pop(); } } static esClave(s) { s = String(s); if("*/+".indexOf(s) !== -1)return false; else { s=s.split("."); if(s.length===1)return false; else return true; } } static compareClaves(a, b) { a=String(a).split('.'); a=parseInt(a[0]); b=String(b).split('.'); b=parseInt(b[0]); return b-a; } static parse(expression,reducir=false,asarray=false) { var infix = this.filtrar(expression); const postfix = this.infixToPostfix(infix); var pf = postfix.split(' '); pf = pf.filter(this.esClave); for (var i = 0; i < pf.length; i++) { pf[i]=this.completarClave(pf[i]); pf[i] = this.clave2binary(pf[i]); } pf.sort(this.compareClaves); return [this.completarClave(this.solvePostfix(postfix),asarray,reducir),pf]; } static mcm(a,b) { var r = a * b; var m = Math.max(a,b); var n = Math.min(a,b); m = m/n; if (Number.isInteger(m)) r = r/n; return r; } static mcd(a, b) { if ((typeof a !== 'number') || (typeof b !== 'number')) return false; a = Math.abs(a); b = Math.abs(b); while(b) { var t = b; b = a % b; a = t; } return a; } static multimcd(lista) { if (toString.call(lista) !== "[object Array]") return  false; var len, a, b; len = lista.length; if ( !len ) { return null; } a = lista[ 0 ]; for ( var i = 1; i < len; i++ ) { b = lista[ i ]; a = this.mcd( a, b ); } return a; } static juntar(c) { for (var i = 0; i < c.length; i++) { c[i]=this.base62encode(c[i]); } return c.join(''); } static romper(c) { c = String(c).split(''); for (var i = 0; i < c.length; i++) { c[i]=this.base62decode(c[i]); } return c; } static completarClave(c,asarray=false,reducir=false) { c = String(c); var silencio=''; if(c.charAt(0)==='-'){ silencio='-'; c=c.replace(/^\-+/,""); } c = c.trim('.').split('.'); var n = parseInt(c[0]); if(c.length==1)c.push(c[0]); c = this.romper(c[1]); var s = []; var m = 0,i = 0; while(m<n) { m+=parseInt(c[i]); if(m>n)s.push(parseInt(c[i])-(m-n)); else s.push(parseInt(c[i])); i++; if(i>=c.length)i=0; } if(reducir){ var divs=[]; for (var i = 0; i < s.length; i++) { const d = this.mcd(n,s[i]); if(d===1){ reducir=false; break; } else { if(divs.indexOf(d)===-1)divs.push(d); } } if(reducir){ reducir = this.multimcd(divs); if(reducir>1){ n=n/reducir; for (var i = 0; i < s.length; i++) { s[i]=s[i]/reducir; } } } } if(asarray)return [n,s,(silencio!=='' ? 1:0)]; else return silencio+n+'.'+this.juntar(s); } static multiplo(m,a) { var x = 0; var z = a[0]*m; for (var i = 0; i < a.length; i++) { x+=parseInt(a[i])*m; a[i]=x; } return a; } static binary2clave(b) { var x = 1,c = []; for (var i = b.length - 1; i >= 0; i--) { if(b[i]==0)x++; else{ c.push(x); x = 1; } } return c.reverse(); } static clave2binary(c) { c = String(c).split('.'); if(c.length===1)c.push(c[0]); c[1]=c[1].split(''); var b = []; for (var i = 0; i < c[1].length; i++) { b.push(1); for (var j = 1; j < c[1][i]; j++) { b.push(0); } } return c[0]+"."+b.join(''); } static conjugar(a,b,asarray=false) { a = this.completarClave(a,true); b = this.completarClave(b,true); a[0]=parseInt(a[0]); b[0]=parseInt(b[0]); const n = this.mcm(a[0],b[0]); const na = this.multiplo(n/a[0],a[1]); const nb = this.multiplo((n/b[0]),b[1]); var bin=[1]; var ja=0,jb=0; var dopush=false; for (var i = 1; i < n; i++) { dopush=false; if(i==na[ja]){ dopush=true; ja++; } if(i==nb[jb]){ dopush=true; jb++; } if(dopush)bin.push(1); else bin.push(0); } const c = this.binary2clave(bin); if(asarray)return [n,c]; else return n+'.'+this.juntar(c); } static apilar(a,b,asarray=false) { a = this.completarClave(a,true); b = this.completarClave(b,true); const n = parseInt(a[0])+parseInt(b[0]); if(asarray)return [n,a.concat(b)]; else return n+'.'+this.juntar(a[1])+this.juntar(b[1]); } static multiplicar(a,x,asarray=false) { a = this.completarClave(a,true); x = x.split('.'); x=parseInt(x[0]); const n = parseInt(a[0])*x; var y=[]; for (var j = 0; j < x; j++) { for (var i = 0; i < a[1].length; i++) { y.push(a[1][i]); } } if(asarray)return [n,y]; else return n+'.'+this.juntar(y); } static operar(a,b,op='+') { if(op==='/') { return this.conjugar(a,b); } else if(op==='+') { return this.apilar(b,a); } else if(op==='*') { return this.multiplicar(b,a); } else { console.log("ERROR: Operacion desconocida: ",op); console.log("a: ",a); console.log("b: ",b); } } static filtrar(c) { return c.replace(/[^a-zA-Z0-9\.+\-*\/()]/gi, ''); } } var beep = (function () { return function (duration, golpe, type, vo, nota, n, oct, finishedCallback) { duration = +duration; if(type<=0 || type>3) type=0; if (typeof finishedCallback != "function") { finishedCallback = function () {}; } if(notu[golpe]>11) { var hertz = getFrequency(nota,n,oct); } else { var hertz = getFrequency(notu[golpe],12,oct); } var osc = actx.createOscillator(); var types = [ 'sine', 'square', 'sawtooth', 'triangle', ]; osc.type = types[type]; var gainNode = actx.createGain(); osc.connect(gainNode); gainNode.connect(actx.destination); gainNode.gain.value = Math.pow(vol,2)*vo*volu[golpe]; osc.frequency.setValueAtTime(hertz, actx.currentTime); if (osc.noteOn) osc.noteOn(0); if (osc.start) osc.start(); setTimeout(function () { if (osc.noteOff) osc.noteOff(0); if (osc.stop) osc.stop(); finishedCallback(); }, duration); }; })(); function getFrequency(nota,n,oct) { nota -= -oct*n; return 32.70 * Math.pow(2, (nota-1) / n); } function getMousePos(c, e) { var rect = c.getBoundingClientRect(); return { x: (800*e.clientX/rect.width) - rect.left - (800/2), y: (800*e.clientY/rect.height) - rect.top - (800/2) }; } function playStart() { clearInterval(sto); clearTiempo(); angulo = 0; for (var i = 0; i < pol.length; i++) { var e = i-(-1); pol[i]['pulso'] = 0; } drawClock(); } function playStop() { clearInterval(sti); clearInterval(sto); } function drawClock() { var redo=true; if(!isPlaying)redo=false; clearInterval(sto); drawFace(ctx, radius); if(redo)drawTime(ctx, radius); regiones=[]; for (var i = 0; i < pol.length; i++) { var e = i-(-1); if(pol[i]['activo'])drawNumbers(ctx, radius*((5-i)/5), pol[i]['nmax'], angulo, i); } var t = tiempo(); if(redo)sto=setTimeout(drawClock,t); } function drawFace(ctx, radius) { ctx.strokeStyle = '#999'; ctx.beginPath(); ctx.arc(0, 0, radius, 0, 2*Math.PI); ctx.fillStyle = '#000'; ctx.fill(); ctx.lineWidth = radius*bordep; ctx.stroke(); ctx.closePath(); var rad = radius*0.83/5; var ra1 = radius*0.1; for (var i = 1; i < 6; i++) { ctx.beginPath(); ctx.arc(0, 0, ra1+rad*(5-i), 0, 2*Math.PI); if(i==5)ctx.fillStyle = '#999'; else if(i/2!=Math.floor(i/2))ctx.fillStyle = '#222'; else ctx.fillStyle = '#000'; ctx.fill(); ctx.closePath(); } } function drawNumbers(ctx, radi, n, a, ii) { var ang,p; ctx.font = radius*0.15 + "px arial"; ctx.textBaseline="middle"; ctx.textAlign="center"; p = Math.ceil(a*n/segs); for(var num = 1; num <= n; num++){ ang = (n+num-1) * Math.PI / (n/2); ctx.beginPath(); ctx.arc(Math.sin(ang)*radi*0.85,-Math.cos(ang)*radi*0.85, radius*0.08, 0, 2*Math.PI); if (p==num)ctx.fillStyle = colores[ii][0]; else ctx.fillStyle = '#444'; ctx.fill(); ctx.closePath(); ctx.rotate(ang); ctx.translate(0, -radi*0.85); ctx.rotate(-ang); if(pol[ii]['patron'][num-1]==0) { ctx.fillStyle = '#333'; ctx.fillText('X', 0, 0); } else if(pol[ii]['patron'][num-1]==2) { ctx.fillStyle = '#f33'; ctx.fillText(num.toString(), 0, 0); } else { if (p==num)ctx.fillStyle = '#fff'; else ctx.fillStyle = colores[ii][1]; ctx.fillText(num.toString(), 0, 0); } var posi = { x:Math.sin(ang)*radi*0.85, y:-Math.cos(ang)*radi*0.85 }; regiones.push({e:ii,n:n,i:num-1,pos:posi}); ctx.rotate(ang); ctx.translate(0, radi*0.85); ctx.rotate(-ang); } } function drawTime(ctx, radius){ angulo++; if(angulo>segs) { angulo=1; compas++; document.getElementById("compas").value=compas; } lista = document.getElementsByClassName('pulso'); for (var i = 0; i < pol.length; i++) { var e = i-(-1); pol[i]['pulso'] = Math.ceil(angulo*pol[i]['nmax']/segs); if(pol[i]['pulso']!=lista[i].value){ if(pol[i]['activo']){ if(pol[i]['patron'][pol[i]['pulso']-1]==0) { } else  { beep(150, pol[i]['patron'][pol[i]['pulso']-1]-1, pol[i]['tipbip'], pol[i]['vol'], pol[i]['pulso'], pol[i]['nmax'], pol[i]['octava']); } } lista[i].value=pol[i]['pulso']; } } var second=((angulo-1)*Math.PI/(segs/2)); drawHand(ctx, second, radius*0.9, radius*0.02); } function drawHand(ctx, second, length, width) { ctx.beginPath(); ctx.lineWidth = width; ctx.lineCap = "round"; ctx.moveTo(0,0); ctx.rotate(second); ctx.lineTo(0, -length); ctx.stroke(); ctx.rotate(-second); ctx.closePath(); } function tiempo() { time += ti; elapsed = Math.floor(time / ti) / 10; if(Math.round(elapsed) == elapsed) { elapsed += '.0'; } var diff = (new Date().getTime() - start) - time; if(diff>precisionmax){ precisionmax=diff; if(precisionmax>1000)document.getElementById('precisionmax').value=-1; else document.getElementById('precisionmax').value=Math.round(precisionmax); if(precisionmax>ti)document.getElementById('precisionmax').style.backgroundColor='#a00'; else document.getElementById('precisionmax').style.backgroundColor='#222'; } var r = (ti - diff); if(r<0)r=0; return r; } function clearTiempo(){ start = new Date().getTime(); time = 0; elapsed = '0.0'; precisionmax=0; document.getElementById('precisionmax').value=0; } function playSync(n=20) { ss = Math.round((new Date().getTime()+(n*1000))/1000)*1000; sti = setTimeout(syncStart,ti); } function syncStart() { clearInterval(sti); var s = new Date().getTime(); document.getElementById('ss').value=Math.round((ss-s)/1000); if(ss<=s)playStart(); else sti=setTimeout(syncStart,ti); } function changeCPM(v) { cpm = v; document.getElementById('cpmslide').value = cpm; document.getElementById('cpm').value = cpm; duracompas = 60/cpm; segs = Math.round( (duracompas*1000) / ti ) ; document.getElementById('segs').value = segs; document.getElementById("cpmr").value=Math.round(60000000/(ti*segs))/1000; updateBPM(); } function updateBPM() { var lista = document.getElementsByClassName('bpm'); for (var i = 0; i < lista.length; ++i) { lista[i].value=Math.round(pol[i]['nmax']*60000/(ti*segs)); } } function doClave(){ clave = document.getElementById('clave').value; var claveRes = mrythm.parse(clave,true); claveRes = claveRes[1]; for (var i = 0; i < 5; i++) { if(i<claveRes.length){ claveRes[i] = String(claveRes[i]).split('.'); pol[i]['activo']=true; pol[i]['nmax']=claveRes[i][0]; pol[i]['patron']=claveRes[i][1].split(''); }else{ pol[i]['activo']=false; } } interfaz(); drawClock(); } document.getElementById('clave').onkeyup = function(event){ this.value = mrythm.filtrar(this.value); if (event.keyCode === 13) { doClave(); event.preventDefault(); } }; volu = [0.5,0.8]; notu = [0,5]; var canvas = document.getElementById("canvas"); var ctx = canvas.getContext("2d"); var clavel = document.getElementById("clave"); clavel.value=clave; var colores = [ ['#099','#9ff'], ['#eb0','#fc9'], ['#e0e','#f9f'], ['#4e4','#9f9'], ['#44e','#99f'], ]; var actx = null; var regiones = []; var isPlaying = false; var radius = canvas.height / 2; var angulo = 0; var cpm = 30; var duracompas = 60/cpm; var ti = 25; var segs = Math.round( (duracompas*1000) / ti ); var compas = 0; var sto; var vol = 0.75; var ss,sti; ctx.translate(radius, radius); var bordep = 0.05; radius = radius * (1-bordep); var start = null, time = 0, elapsed = '0.0'; var precisionmax = 0; document.getElementById("ti").value=ti; document.getElementById("segs").value=segs; document.getElementById("vol").value=vol; document.getElementById("cpm").value=cpm; document.getElementById("cpmslide").value=cpm; document.getElementById("cpmr").value=Math.round(60000000/(ti*segs))/1000; document.getElementById("compas").value=compas; document.getElementById("volu1").value=volu[0]; document.getElementById("volu2").value=volu[1]; document.getElementById("notu1").value=notu[0]; document.getElementById("notu2").value=notu[1]; function interfaz(){ var claNames = ['nmax','octava','tipbip','vol']; var lista; for (var j = 0; j < claNames.length; j++) { lista = document.getElementsByClassName(claNames[j]); for (var i = 0; i < lista.length; ++i) { lista[i].value=pol[i][claNames[j]]; } } lista = document.getElementsByClassName('activo'); for (var i = 0; i < lista.length; ++i) { lista[i].checked=pol[i]['activo']; } updateBPM(); lista = document.getElementsByClassName('nmax'); for (var i = 0; i < lista.length; ++i) { (function(index){ lista[index].onchange = function() { pol[index]['nmax']=this.value; var mem = pol[index]['patron']; pol[index]['patron']=[]; for (var i = 0; i < pol[index]['nmax']; i++) { if(mem[i]>=0)pol[index]['patron'].push(mem[i]); else pol[index]['patron'].push(1); } document.getElementsByClassName('bpm')[index].value=Math.round(this.value*60000/(ti*segs)); drawClock(); }; }(i)); } lista = document.getElementsByClassName('octava'); for (var i = 0; i < lista.length; ++i) { (function(index){ lista[index].onchange = function() { pol[index]['octava']=this.value; }; }(i)); } lista = document.getElementsByClassName('tipbip'); for (var i = 0; i < lista.length; ++i) { (function(index){ lista[index].onchange = function() { pol[index]['tipbip']=this.value; }; }(i)); } lista = document.getElementsByClassName('vol'); for (var i = 0; i < lista.length; ++i) { (function(index){ lista[index].onchange = function() { pol[index]['vol']=parseFloat(this.value); }; lista[index].ondblclick = function() { this.value=0.5; pol[index]['vol']=0.5; }; }(i)); } lista = document.getElementsByClassName('activo'); for (var i = 0; i < lista.length; ++i) { (function(index){ lista[index].onchange = function() { pol[index]['activo']=this.checked; drawClock(); }; }(i)); } } doClave(); drawFace(ctx,radius); interfaz(); drawClock(); canvas.onclick=function (evt) { var mousePos = getMousePos(canvas, evt); for (var i = 0; i < regiones.length; i++) { if(Math.abs(regiones[i].pos.x-mousePos.x)<radius*0.08 && Math.abs(regiones[i].pos.y-mousePos.y)<radius*0.08) { if(pol[regiones[i].e]['patron'][regiones[i].i]>1)pol[regiones[i].e]['patron'][regiones[i].i]=0; else if(pol[regiones[i].e]['patron'][regiones[i].i]==1)pol[regiones[i].e]['patron'][regiones[i].i]=2; else pol[regiones[i].e]['patron'][regiones[i].i]=1; drawClock(); } } }; document.getElementById('canvasResizer').onclick = function(){ this.style.width=this.style.height; }; document.getElementById('compas').onchange = function() { compas=this.value; }; document.getElementById('vol').onchange = function() { vol=this.value; }; document.getElementById('vol').ondblclick = function() { this.value = 0.5; vol = 0.5; }; document.getElementById('volu1').onchange = function() { volu[0]=this.value; }; document.getElementById('volu2').onchange = function() { volu[1]=this.value; }; document.getElementById('notu1').onchange = function() { notu[0]=this.value; }; document.getElementById('notu2').onchange = function() { notu[1]=this.value; }; document.getElementById('cpmslide').onchange = function() { changeCPM(this.value); }; document.getElementById('cpm').onchange = function() { changeCPM(this.value); }; document.getElementById('playButton').onclick = function() { if(isPlaying){ this.textContent="PLAY"; toggleClass('playButton',"w3-green"); toggleClass('playButton',"w3-red"); isPlaying=false; playStop(); }else{ actx = new AudioContext(); this.textContent="STOP"; toggleClass('playButton',"w3-green"); toggleClass('playButton',"w3-red"); isPlaying=true; compas = 1; document.getElementById('compas').value=compas; playStart(); } }; document.getElementById('playSync').onclick = function() { playSync(document.getElementById('ss').value); }; document.getElementById('ti').onchange = function() { ti=this.value; segs = Math.round( (duracompas*1000) / ti ) ; document.getElementById("segs").value=segs; document.getElementById("cpmr").value=Math.round(60000000/(ti*segs))/1000; updateBPM(); }; document.getElementById('segs').onchange = function() { segs=this.value; ti = Math.round( (duracompas*1000*1000) / segs ) / 1000 ; document.getElementById("ti").value=ti; document.getElementById("cpmr").value=Math.round(60000000/(ti*segs))/1000; updateBPM(); }; </script>
</body>
</html>
