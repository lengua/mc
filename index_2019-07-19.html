<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Metrónomo circular</title>
  <link rel="stylesheet" type="text/css" href="w3.css">
  <style type="text/css">
    *{
      padding:0;
      margin:0;
    }
    body {
      background-color:#444;
    }
    input,td.text {
      color: #ddd;
      background-color: transparent;
      border: none;
      font-family: "Courier New",Courier,monospace;
      width: 100px;
      font-size: 1.2em;
    }
    input {
      text-align: center;
    }
    button {
      color: #ddd;
      background-color: #333;
      font-family: "Courier New",Courier,monospace;
      font-size: 1.2em;
      margin: 5px;
      padding: 6px;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background-color: #633;
    }
    td.text {
      text-align: right;
    }
    .exterior {
      border: 1px solid #666;
      padding:0;
      margin:0;
      background: #222;
    }
    .exterior div {
      vertical-align: top;
    }
    tr,td {
      padding:0;
      margin:0;
    }
    table.interior td {
      padding-right: 20px;
    }
    table.interior td:nth-child(1) {
      text-align: right;
      padding-left: 20px;
    }
    .oculto {
      height: 0px;
      overflow: auto;
    }
    .rs {
      border: 1px solid #666;
      resize: both;
      overflow: hidden;
      width: 400px;
      height: 400px;
    }
    #canvas {
      background-color:transparent;
      height: inherit;
    }
    .fondo {
      background: #222;
    }
    .fondo1 {
      background: #333;
    }
    .fondo2 {
      background: #444;
    }
    input.chico {
      width: 60px;
    }
  </style>
</head>
<body>

<div class="exterior w3-cell">
  <div class="w3-cell">
    <div class="rs" id="canvasResizer">
      <canvas id="canvas" width="800" height="800"></canvas>
    </div>
  </div>
  <div class="w3-cell">
    <table class="interior">
      <tr>
        <td colspan="2" style="text-align:center;"><button id="playButton">Play</button><button id="stopButton">Stop</button><br><button id="playSync">PlaySync</button><input type="number" id="ss" value="2" style="width: 40px;"></td>
      </tr>
      <tr class="w3-large">
        <td class="text">Volumen:</td><td><input type="range" id="vol" min="0" max="0.2" step="0.01"></td>
      </tr>
      <tr class="w3-large">
        <td class="text">Número:</td><td><input class="chico" type="number" id="nmax" value="" min="0" max="64"><input class="chico" type="number" id="nmax2" value="" min="0" max="64"></td>
      </tr>
      <tr class="w3-large">
        <td class="text">Octava:</td><td><input class="chico" type="number" id="octava" value="" min="0" max="10" step="1"><input class="chico" type="number" id="octava2" value="" min="0" max="10" step="1"></td>
      </tr>
      <tr class="w3-large">
        <td class="text">Tipo&nbsp;Beep:</td><td><input class="chico" type="number" id="tipbip" min=0 max=3 step=1 value=""><input class="chico" type="number" id="tipbip2" min=0 max=3 step=1 value=""></td>
      </tr>
      <tr class="fondo1 w3-large">
        <td class="text">Pulso:</td><td><input class="chico" type="text" id="pulso" readonly="readonly"><input class="chico" type="text" id="pulso2" readonly="readonly"></td>
      </tr>
    </table>
    <div align="center" class="w3-text-white w3-small"><a href="#" class="w3-text-gray" onclick="toggleClass('vermas','oculto');">Ver más</a></div>
    <div class="oculto" id="vermas">
      <table class="interior">
        <tr>
          <td class="text">Compás:</td><td><input type="number" id="compas" step=1></td>
        </tr>
        <tr class="fondo1">
          <td class="text">Ángulo:</td><td><input type="text" id="angulo" readonly="readonly"></td>
        </tr>
        <tr>
          <td class="text">Segs:</td><td><input type="number" id="segs" value=""></td>
        </tr>
        <tr>
          <td class="text">Ti:</td><td><input type="number" id="ti" step="0.001" value=""></td>
        </tr>
        <tr>
          <td class="text">CPM:</td><td><input type="number" step="0.01" id="cpm" value=""></td>
        </tr>
        <tr>
          <td class="text">BPM:</td><td><input class="chico" type="number" id="bpm" value=""><input class="chico" type="number" id="bpm2" value=""></td>
        </tr>
        <tr class="fondo1">
          <td class="text">Precisión:</td><td><input type="text" id="precisionmax" readonly="readonly" ondblclick="precisionmax=0;" style="width: 60px;"><input type="text" id="precision" readonly="readonly" style="width: 60px;"></td>
        </tr>
      </table>
    </div>
  </div>
</div>

<script>
function toggleClass(id,cla) {
  var element = document.getElementById(id);
  if (element.classList) { 
    element.classList.toggle(cla);
  } else {
    var classes = element.className.split(" ");
    var i = classes.indexOf(cla);
    if (i >= 0) 
      classes.splice(i, 1);
    else 
      classes.push(cla);
      element.className = classes.join(" "); 
  }
}
// Objetos y Variables globales
var canvas = document.getElementById("canvas");
var ctx = canvas.getContext("2d");
var radius = canvas.height / 2;
var angulo = 0;
var pulso = 0;
var pulso2 = 0;
var nmax = 7;
var nmax2 = 5;
var octava = 3;
var octava2 = 2;
var segs = 60;
var ti = Math.round(1000000/30)/1000;
var compas = 0;
var sto;
var tipbip = 3;
var tipbip2 = 3;
var vol = 0.03;
var ss,sti;
ctx.translate(radius, radius); // Movemos el centro
var bordep = 0.05; // Porcentaje de borde (0 - 1)
radius = radius * (1-bordep); // Un poco más pequeño que el canvas
// Variables para mantener la precisión en el tiempo
var start = null,  
    time = 0,  
    elapsed = '0.0';
var precisionmax = 0;

// Definiciones interfaz ----------
document.getElementById("nmax").value=nmax;
document.getElementById("nmax2").value=nmax2;
document.getElementById("octava").value=octava;
document.getElementById("octava2").value=octava2;
document.getElementById("ti").value=ti;
document.getElementById("segs").value=segs;
document.getElementById("tipbip").value=tipbip;
document.getElementById("tipbip2").value=tipbip2;
document.getElementById("vol").value=vol;
// 60000/(ti*segs) // Tiempo por vuelta en ms / minuto
document.getElementById("cpm").value=Math.round(600000/(ti*segs))/10;
document.getElementById("bpm").value=Math.round(nmax*60000/(ti*segs));
document.getElementById("bpm2").value=Math.round(nmax2*60000/(ti*segs));
document.getElementById("compas").value=compas;

drawFace(ctx,radius);

// Funciones para mantener la precisión en el tiempo
function tiempo() {  
    time += ti;  
    elapsed = Math.floor(time / ti) / 10;  
    if(Math.round(elapsed) == elapsed) { elapsed += '.0'; }  
    var diff = (new Date().getTime() - start) - time;
    document.getElementById('precision').value=Math.round(diff);
    if(diff>precisionmax)precisionmax=diff;
    document.getElementById('precisionmax').value=Math.round(precisionmax);
    var r = (ti - diff);
    // console.log("t:",ti,"r:",r);
    if(r<0)r=0;
    return r;
}
function clearTiempo(){
  start = new Date().getTime(); 
  time = 0;
  elapsed = '0.0';
  precisionmax=0;
  document.getElementById('precision').value=0;
  document.getElementById('precisionmax').value=0;
}
// SyncStart funciones
function playSync(n=20) {
  ss = Math.round((new Date().getTime()+(n*1000))/1000)*1000;
  sti = setTimeout(syncStart,ti);
}
function syncStart() {
  clearInterval(sti);
  var s = new Date().getTime();
  document.getElementById('ss').value=Math.round((ss-s)/1000);
  if(ss<=s)playStart()
  else sti = setTimeout(syncStart,ti);
}

// Listeners ----------------------
document.getElementById('canvasResizer').onclick = function(){
  this.style.width=this.style.height;
};
document.getElementById('nmax').onchange = function() {
  nmax=this.value;
  document.getElementById("bpm").value=Math.round(nmax*60000/(ti*segs));
};
document.getElementById('nmax2').onchange = function() {
  nmax2=this.value;
  document.getElementById("bpm2").value=Math.round(nmax2*60000/(ti*segs));
};
document.getElementById('compas').onchange = function() {
  compas=this.value;
};
document.getElementById('octava').onchange = function() {
  octava=this.value;
};
document.getElementById('octava2').onchange = function() {
  octava2=this.value;
};
document.getElementById('vol').onchange = function() {
  vol=this.value;
};
document.getElementById('tipbip').onchange = function() {
  tipbip=this.value;
};
document.getElementById('tipbip2').onchange = function() {
  tipbip2=this.value;
};
document.getElementById('playButton').onclick = function() {
  playStart();
};
document.getElementById('playSync').onclick = function() {
  playSync(document.getElementById('ss').value);
};
document.getElementById('stopButton').onclick = function() {
  playStop();
};
document.getElementById('ti').onchange = function() {
  ti=this.value;
  // segs = Math.round(4000/this.value);
  // ti = Math.round(1000/segs);
  // document.getElementById("segs").value=segs;
  document.getElementById("cpm").value=Math.round(600000/(ti*segs))/10;
  document.getElementById("bpm").value=Math.round(nmax*60000/(ti*segs));
  document.getElementById("bpm2").value=Math.round(nmax2*60000/(ti*segs));
};
document.getElementById('segs').onchange = function() {
  segs=this.value;
  // ti = Math.round(1000/segs);
  // document.getElementById("ti").value=ti;
  document.getElementById("cpm").value=Math.round(600000/(ti*segs))/10;
  document.getElementById("bpm").value=Math.round(nmax*60000/(ti*segs));
  document.getElementById("bpm2").value=Math.round(nmax2*60000/(ti*segs));
};
document.getElementById('cpm').onchange = function() {
  // cpm=this.value;
};
document.getElementById('bpm').onchange = function() {
  // cpm=this.value;
};
document.getElementById('bpm2').onchange = function() {
  // cpm=this.value;
};


// FUNCIONES ----------------------
function playStart() {
  // Loop del intervalo
  clearInterval(sto);
  clearTiempo();
  angulo = 0;
  pulso = 0;
  pulso2 = 0;
  drawClock();
}
function playStop() {
  // Loop del intervalo
  clearInterval(sti);
  clearInterval(sto);
}

// Funciones del reloj
function drawClock() {
  clearInterval(sto);
  drawFace(ctx, radius);
  drawTime(ctx, radius);
  drawNumbers(ctx, radius, nmax, angulo);
  drawNumbers(ctx, radius*(4/5), nmax2, angulo);
  var t = tiempo();
  // console.log('drawClock:',ti,t);
  sto = setTimeout(drawClock, t);
}
function drawFace(ctx, radius) {
  ctx.strokeStyle = '#999'; // Color de borde
  // Dibuja el círculo fondo y el borde exterior
  ctx.beginPath();
  ctx.arc(0, 0, radius, 0, 2*Math.PI);
  ctx.fillStyle = '#000'; // Color del fondo del reloj
  ctx.fill();
  ctx.lineWidth = radius*bordep; // Lo que sobra es borde
  ctx.stroke();
  // Círculos Niveles
  var rad = radius*0.83/5;
  var ra1 = radius*0.1;
  for (var i = 1; i < 6; i++) {
    ctx.beginPath();
    ctx.arc(0, 0, ra1+rad*(5-i), 0, 2*Math.PI);
    if(i==5)ctx.fillStyle = '#999'; //Circulo central
    else if(i/2!=Math.floor(i/2))ctx.fillStyle = '#222'; // Claro
    else ctx.fillStyle = '#000'; // Obscuro
    ctx.fill();
  }
}
function drawNumbers(ctx, radius, n, a) {
  var ang,p;
  ctx.font = radius*0.15 + "px arial";
  ctx.textBaseline="middle";
  ctx.textAlign="center";
  p = Math.ceil(a*n/segs);
  for(var num = 1; num <= n; num++){
    ang = (n+num-1) * Math.PI / (n/2);

    ctx.beginPath();
    ctx.arc(Math.sin(ang)*radius*0.85,-Math.cos(ang)*radius*0.85, radius*0.08, 0, 2*Math.PI);
    if (p==num)ctx.fillStyle = '#099';
    else ctx.fillStyle = '#222';
    ctx.fill();

    ctx.rotate(ang);
    ctx.translate(0, -radius*0.85);
    ctx.rotate(-ang);
    if (p==num)ctx.fillStyle = '#fff';
    else ctx.fillStyle = '#9ff';
    ctx.fillText(num.toString(), 0, 0);
    ctx.rotate(ang);
    ctx.translate(0, radius*0.85);
    ctx.rotate(-ang);
  }
  /* Segunda capa test
  radi=radius*0.81;
  var n=7;
  p = Math.ceil(a*n/segs);
  for(var num = 1; num <= n; num++){
    ang = (n+num-1) * Math.PI / (n/2);

    ctx.beginPath();
    ctx.arc(Math.sin(ang)*radi*0.85,-Math.cos(ang)*radi*0.85, radius*0.08, 0, 2*Math.PI);
    if (p==num)ctx.fillStyle = '#e80';
    else ctx.fillStyle = '#111';
    ctx.fill();

    ctx.rotate(ang);
    ctx.translate(0, -radi*0.85);
    ctx.rotate(-ang);
    if (p==num) ctx.fillStyle = '#fff';
    else ctx.fillStyle = '#ff9';
    ctx.fillText(num.toString(), 0, 0);
    ctx.rotate(ang);
    ctx.translate(0, radi*0.85);
    ctx.rotate(-ang);
  }
  // Tercera capa test
  radi=radi*0.75;
  var n=5;
  p = Math.ceil(a*n/segs);
  for(var num = 1; num <= n; num++){
    ang = (n+num-1) * Math.PI / (n/2);

    ctx.beginPath();
    ctx.arc(Math.sin(ang)*radi*0.85,-Math.cos(ang)*radi*0.85, radius*0.08, 0, 2*Math.PI);
    if (p==num)ctx.fillStyle = '#e0e';
    else ctx.fillStyle = '#222';
    ctx.fill();

    ctx.rotate(ang);
    ctx.translate(0, -radi*0.85);
    ctx.rotate(-ang);
    if (p==num) ctx.fillStyle = '#fff';
    else ctx.fillStyle = '#f9f';
    ctx.fillText(num.toString(), 0, 0);
    ctx.rotate(ang);
    ctx.translate(0, radi*0.85);
    ctx.rotate(-ang);
  }
  // Cuarta capa test
  radi=radi*0.67;
  var n=3;
  p = Math.ceil(a*n/segs);
  for(var num = 1; num <= n; num++){
    ang = (n+num-1) * Math.PI / (n/2);

    ctx.beginPath();
    ctx.arc(Math.sin(ang)*radi*0.85,-Math.cos(ang)*radi*0.85, radius*0.08, 0, 2*Math.PI);
    if (p==num)ctx.fillStyle = '#4e4';
    else ctx.fillStyle = '#111';
    ctx.fill();

    ctx.rotate(ang);
    ctx.translate(0, -radi*0.85);
    ctx.rotate(-ang);
    if (p==num) ctx.fillStyle = '#fff';
    else ctx.fillStyle = '#9f9';
    ctx.fillText(num.toString(), 0, 0);
    ctx.rotate(ang);
    ctx.translate(0, radi*0.85);
    ctx.rotate(-ang);
  }
  // Quinta capa test
  radi=radi*0.52;
  var n=2;
  p = Math.ceil(a*n/segs);
  for(var num = 1; num <= n; num++){
    ang = (n+num-1) * Math.PI / (n/2);

    ctx.beginPath();
    ctx.arc(Math.sin(ang)*radi*0.85,-Math.cos(ang)*radi*0.85, radius*0.08, 0, 2*Math.PI);
    if (p==num)ctx.fillStyle = '#44e';
    else ctx.fillStyle = '#111';
    ctx.fill();

    ctx.rotate(ang);
    ctx.translate(0, -radi*0.85);
    ctx.rotate(-ang);
    if (p==num) ctx.fillStyle = '#fff';
    else ctx.fillStyle = '#99f';
    ctx.fillText(num.toString(), 0, 0);
    ctx.rotate(ang);
    ctx.translate(0, radi*0.85);
    ctx.rotate(-ang);
  }*/
}
function drawTime(ctx, radius){
  angulo++;
  if(angulo>segs) {
    angulo=1;
    compas++;
    document.getElementById("compas").value=compas;
  }
  document.getElementById("angulo").value=angulo;
  pulso = Math.ceil(angulo*nmax/segs);
  if(pulso!=document.getElementById("pulso").value){
    beep(150, tipbip, pulso, nmax, octava);
    document.getElementById("pulso").value=pulso;
  }
  pulso2 = Math.ceil(angulo*nmax2/segs);
  if(pulso2!=document.getElementById("pulso2").value){
    beep(150, tipbip2, pulso, nmax2, octava2);
    document.getElementById("pulso2").value=pulso2;
  }
  var second=((angulo-1)*Math.PI/(segs/2));
  drawHand(ctx, second, radius*0.9, radius*0.02);
}
function drawHand(ctx, second, length, width) {
  ctx.beginPath();
  ctx.lineWidth = width;
  ctx.lineCap = "round";
  ctx.moveTo(0,0);
  ctx.rotate(second);
  ctx.lineTo(0, -length);
  ctx.stroke();
  ctx.rotate(-second);
}

// Sonido con ocilador
var beep = (function () {
  var ctxClass = window.audioContext ||window.AudioContext || window.AudioContext || window.webkitAudioContext
  var ctx = new ctxClass();
  return function (duration, type, nota, n, oct, finishedCallback) {

    duration = +duration;

    // Only 0-3 are valid types.
    if(type<=0 || type>3) type=0;

    if (typeof finishedCallback != "function") {
        finishedCallback = function () {};
    }

    var hertz = getFrequency(nota,n,oct);

    var osc = ctx.createOscillator();
    var types = [
      'sine', // A sine wave. This is the default value.
      'square', // A square wave with a duty cycle of 0.5; that is, the signal is "high" for half of each period.
      'sawtooth', // A sawtooth wave.
      'triangle', // A triangle wave.
    ];
    osc.type = types[type];
    //osc.type = "sine";


    // osc.connect(ctx.destination);
    var gainNode = ctx.createGain();
    osc.connect(gainNode);
    gainNode.connect(ctx.destination);
    gainNode.gain.value = vol;
    // if (osc.noteOff) {
    //   try{osc.noteOff(0);}
    //   catch(error) {console.log("No osc.noteOff");}
    // }
    // if (osc.stop) {
    //   try{osc.stop();}
    //   catch(error){console.log("No osc.stop");}
    // }
    osc.frequency.setValueAtTime(hertz, ctx.currentTime);
    // gainNode.gain.exponentialRampToValueAtTime(vol, ctx.currentTime+0.1);
    if (osc.noteOn) osc.noteOn(0);
    if (osc.start) osc.start();

    setTimeout(function () {
      // gainNode.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.1);
      if (osc.noteOff) osc.noteOff(0);
      if (osc.stop) osc.stop();
      finishedCallback();
    }, duration);

  };
})();
var getFrequency = function (nota,n,oct) {
  nota += oct*n;
  return 32.70 * Math.pow(2, (nota-1) / n);
};

</script>

</body>
</html>
